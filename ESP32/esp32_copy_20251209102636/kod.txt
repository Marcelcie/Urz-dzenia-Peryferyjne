#include <WiFi.h>

const char* ssid = "linksys";
const char* password = "";

const char* host = "192.168.1.100";
const uint16_t port = 12345;

WiFiClient client;

void activateDevice() {
  Serial.println("=== URZĄDZENIE AKTYWOWANE ===");
  pinMode(2, OUTPUT);
  digitalWrite(2, HIGH);
  delay(200);
  digitalWrite(2, LOW);
  pinMode(4, INPUT_PULLUP);
  analogSetAttenuation(ADC_11db);
  Serial.println("Sprzęt zainicjalizowany");
}

void setup() {
  Serial.begin(115200);
  delay(2000);
  Serial.println("\n=== DIAGNOSTYKA WIFI ===");
  activateDevice();
  
  // 1. SKAN SIECI
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();
  delay(1000);
  
  Serial.println("SZUKANIE SIECI...");
  int n = WiFi.scanNetworks();
  Serial.printf("Znaleziono %d sieci\n\n", n);
  
  bool found = false;
  for (int i = 0; i < n; i++) {
   Serial.printf("  %d: '%s'  %ddB  %s\n", 
                i+1, WiFi.SSID(i).c_str(), WiFi.RSSI(i),
                  WiFi.encryptionType(i) == WIFI_AUTH_OPEN ? "OTWARTA" : "HASŁO");
    if (WiFi.SSID(i) == ssid) found = true;
  }
  
  if (!found) {
    Serial.printf("\n❌ SIECI '%s' NIE ZNALEZIONO!\n", ssid);
    return;
  }
  
  Serial.printf("\nPróba połączenia z '%s'...\n", ssid);
  
  // 2. POPRAWNE POŁĄCZENIE
  WiFi.begin(ssid, password);
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    Serial.printf(" [%d]", WiFi.status());
    attempts++;
  }
  
  Serial.println();
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("✅ POŁĄCZONO!");
    Serial.print("IP: "); Serial.println(WiFi.localIP());
    Serial.print("RSSI: "); Serial.println(WiFi.RSSI());
  } else {
    Serial.println("\n❌ BŁĄD POŁĄCZENIA!");
    Serial.printf("Status: %d\n", WiFi.status());
    Serial.println("Możliwe przyczyny:");
    Serial.println("- Błędne hasło");
    Serial.println("- Router WPA3 (zmień na WPA2)");
    Serial.println("- Filtr MAC adresów");
    Serial.println("- Zasięg za słaby");
  }
}

void loop() {
  delay(5000);
  Serial.print("Status WiFi: "); Serial.println(WiFi.status());
}
